# ===========================================================
#  MediaPipe Dev Environment (JetPack 7 / L4T r36.4.7)
#  Always install latest packages, then record versions
# ===========================================================

FROM nvcr.io/nvidia/l4t-base:r36.2.0

LABEL maintainer="Khongmeng Kormoua"
LABEL description="MediaPipe + OpenCV + Bazel dev image (latest packages with version manifest)"

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
WORKDIR /workspace

# -----------------------------------------------------------
# 1. System + Python deps
# -----------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential cmake unzip pkg-config git curl wget nano \
    python3 python3-pip python3-dev python3-opencv \
    ffmpeg libsm6 libxext6 libgl1-mesa-glx \
    openjdk-11-jdk protobuf-compiler libprotobuf-dev libopencv-dev \
    libjpeg-dev libpng-dev libtiff-dev mesa-utils \
    && rm -rf /var/lib/apt/lists/*

RUN python3 -m pip install --upgrade pip setuptools wheel
RUN pip install numpy absl-py matplotlib opencv-python-headless protobuf tqdm

# -----------------------------------------------------------
# 2. Bazelisk
# -----------------------------------------------------------
RUN LATEST=$(curl -s https://api.github.com/repos/bazelbuild/bazelisk/releases/latest \
      | grep browser_download_url | grep linux-arm64 | cut -d '"' -f 4) \
 && wget $LATEST -O /usr/local/bin/bazel \
 && chmod +x /usr/local/bin/bazel

# -----------------------------------------------------------
# 3. Clone MediaPipe
# -----------------------------------------------------------
RUN git clone https://github.com/google/mediapipe.git
WORKDIR /workspace/mediapipe

# -----------------------------------------------------------
# 4. Environment variables
# -----------------------------------------------------------
ENV CUDA_HOME=/usr/local/cuda
# ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64:${LD_LIBRARY_PATH}
ENV LD_LIBRARY_PATH=/usr/local/cuda-12.6/lib64:/usr/local/cuda/lib64:/usr/lib/aarch64-linux-gnu:/usr/lib/aarch64-linux-gnu/tegra
ENV PATH=/usr/local/cuda/bin:${PATH}

# -----------------------------------------------------------
# 5. Record versions of all components
# -----------------------------------------------------------
# RUN mkdir -p /workspace/version_logs && \
#     echo "===== BUILD INFO =====" > /workspace/version_logs/version_manifest.txt && \
#     date >> /workspace/version_logs/version_manifest.txt && \
#     echo "\n--- JetPack / L4T ---" >> /workspace/version_logs/version_manifest.txt && \
#     cat /etc/nv_tegra_release >> /workspace/version_logs/version_manifest.txt && \
#     echo "\n--- Bazelisk ---" >> /workspace/version_logs/version_manifest.txt && \
#     bazel version >> /workspace/version_logs/version_manifest.txt || true && \
#     echo "\n--- Git commits ---" >> /workspace/version_logs/version_manifest.txt && \
#     cd /workspace/mediapipe && git log -1 >> /workspace/version_logs/version_manifest.txt && \
#     echo "\n--- APT packages ---" >> /workspace/version_logs/version_manifest.txt && \
#     apt list --installed >> /workspace/version_logs/version_manifest.txt && \
#     echo "\n--- PIP packages ---" >> /workspace/version_logs/version_manifest.txt && \
#     pip freeze >> /workspace/version_logs/version_manifest.txt

CMD ["bash"]